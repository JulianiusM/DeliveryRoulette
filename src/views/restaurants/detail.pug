//- views/restaurants/detail.pug - Restaurant Detail
extends ../layout

block meta
    title #{data.restaurant.name} | DeliveryRoulette

block title
    h1.card-header.text-center
        i.bi.bi-shop.me-2
        | #{data.restaurant.name}

block content
    - const r = data.restaurant
    - const categories = data.categories || []
    - const dietSuitability = data.dietSuitability || []
    - const itemDietChips = data.itemDietChips || {}
    - const cuisineProfile = data.cuisineProfile || null
    - const providerCuisines = data.providerCuisines || []
    - const openingDayList = (r.openingDays || '').split(',').map((d) => d.trim()).filter(Boolean)
    - const openingHourLines = (r.openingHours || '').split('\n').map((l) => l.trim()).filter(Boolean)

    .row.g-4
        .col-md-8
            .card.text-bg-dark.border-secondary
                .card-header
                    i.bi.bi-geo-alt.me-2
                    | Address
                .card-body
                    p.mb-1 #{r.addressLine1}
                    if r.addressLine2
                        p.mb-1 #{r.addressLine2}
                    p.mb-0 #{r.postalCode} #{r.city}
                    if r.country
                        p.mb-0 #{r.country}
                    if openingDayList.length > 0
                        hr.border-secondary
                        p.mb-2
                            strong Opening Days
                        .d-flex.flex-wrap.gap-1.mb-2
                            each dayName in openingDayList
                                span.badge.text-bg-secondary #{dayName}
                    if openingHourLines.length > 0
                        p.mb-2.mt-3
                            strong Opening Hours
                        ul.list-group.list-group-flush
                            each line in openingHourLines
                                - const separatorIndex = line.indexOf(':')
                                li.list-group-item.bg-dark.text-light.border-secondary.small.py-2.px-2
                                    if separatorIndex > 0
                                        strong.me-2 #{line.slice(0, separatorIndex)}:
                                        span.text-white-50 #{line.slice(separatorIndex + 1).trim()}
                                    else
                                        span.text-white-50 #{line}

        .col-md-4
            .card.text-bg-dark.border-secondary
                .card-header
                    i.bi.bi-info-circle.me-2
                    | Info
                .card-body
                    p.mb-2
                        | Listing:&nbsp;
                        if r.isActive
                            span.badge.text-bg-success Enabled
                        else
                            span.badge.text-bg-secondary Disabled
                    p.mb-2
                        | Open now:&nbsp;
                        if data.isOpenNow === true
                            span.badge.text-bg-success Open
                        else if data.isOpenNow === false
                            span.badge.text-bg-danger Closed
                        else
                            span.badge.text-bg-secondary Unknown
                    p.text-white-50.small.mb-2
                        | "Listing" controls whether this restaurant is available in the app.
                        br
                        | "Open now" is computed from stored opening hours and current local time.
                    p.text-white-50.mb-1
                        small Created: #{new Date(r.createdAt).toLocaleDateString()}
                    p.text-white-50.mb-0
                        small Updated: #{new Date(r.updatedAt).toLocaleDateString()}

            - const isFavorite = data.isFavorite || false
            - const doNotSuggest = data.doNotSuggest || false
            .card.text-bg-dark.border-secondary.mt-3
                .card-header
                    i.bi.bi-sliders.me-2
                    | My Preferences
                .card-body
                    .d-flex.flex-column.gap-2
                        form(method="POST" action=`/restaurants/${r.id}/toggle-favorite`)
                            +csrf
                            button.btn.btn-sm.w-100(type="submit" class=isFavorite ? 'btn-warning' : 'btn-outline-warning')
                                i.bi.me-1(class=isFavorite ? 'bi-star-fill' : 'bi-star')
                                | #{isFavorite ? 'Unfavorite' : 'Favorite'}
                        form(method="POST" action=`/restaurants/${r.id}/toggle-do-not-suggest`)
                            +csrf
                            button.btn.btn-sm.w-100(type="submit" class=doNotSuggest ? 'btn-danger' : 'btn-outline-danger')
                                i.bi.me-1(class=doNotSuggest ? 'bi-x-circle-fill' : 'bi-x-circle')
                                | #{doNotSuggest ? 'Allow Suggestions' : 'Do Not Suggest'}

            .card.text-bg-dark.border-secondary.mt-3
                .card-header
                    i.bi.bi-globe-asia-australia.me-2
                    | Cuisines
                .card-body
                    if providerCuisines.length > 0
                        p.text-white-50.small.mb-1 Provider Cuisines
                        .d-flex.flex-wrap.gap-1.mb-2
                            each cuisine in providerCuisines
                                span.badge.text-bg-info.text-dark #{cuisine}
                    else
                        p.text-white-50.small.mb-2 No provider cuisines saved.

                    if cuisineProfile && cuisineProfile.cuisines && cuisineProfile.cuisines.length > 0
                        p.text-white-50.small.mb-1 Heuristic Cuisines
                        .d-flex.flex-wrap.gap-1
                            each cuisine in cuisineProfile.cuisines
                                span.badge(class=cuisine.source === 'provider' ? 'text-bg-info text-dark' : 'text-bg-dark border border-secondary')
                                    | #{cuisine.label} (#{cuisine.score}% #{cuisine.confidence})
                    else
                        p.text-white-50.small.mb-0 No inferred cuisines yet.

    include _diet_suitability

    - const providerRefs = data.providerRefs || []
    .card.text-bg-dark.border-secondary.mt-4
        .card-header.d-flex.justify-content-between.align-items-center
            span
                i.bi.bi-link-45deg.me-2
                | Provider References
            button.btn.btn-sm.btn-success(type="button" data-bs-toggle="collapse" data-bs-target="#addProviderForm")
                i.bi.bi-plus-lg.me-1
                | Add Provider
        .card-body
            #addProviderForm.collapse.mb-3
                form(method="POST" action=`/restaurants/${r.id}/providers`)
                    +csrf
                    .row.g-2
                        .col-md-3
                            input.form-control.form-control-sm(type="text" name="providerKey" placeholder="Provider key (e.g. uber_eats)" required)
                        .col-md-3
                            input.form-control.form-control-sm(type="text" name="externalId" placeholder="External ID (optional)")
                        .col-md-4
                            input.form-control.form-control-sm(type="url" name="url" placeholder="URL" required)
                        .col-md-2
                            button.btn.btn-sm.btn-success.w-100(type="submit")
                                i.bi.bi-plus-lg.me-1
                                | Add

            if providerRefs.length === 0
                .text-center.text-white-50.py-3
                    i.bi.bi-link-45deg.d-block.display-6.mb-2
                    p No provider references yet.
            else
                .table-responsive
                    table.table.table-dark.table-hover.mb-0
                        thead
                            tr
                                th Provider
                                th External ID
                                th URL
                                th Status
                                th Actions
                        tbody
                            each ref in providerRefs
                                tr
                                    td #{ref.providerKey}
                                    td.text-white-50 #{ref.externalId || '-'}
                                    td
                                        a.text-info(href=ref.url target="_blank" rel="noopener noreferrer") #{ref.url}
                                    td
                                        span.badge(class=ref.status === 'active' ? 'text-bg-success' : 'text-bg-secondary') #{ref.status}
                                    td
                                        .d-flex.gap-1
                                            form.d-inline(method="POST" action=`/restaurants/${r.id}/providers/${ref.id}/sync-menu`)
                                                +csrf
                                                button.btn.btn-sm.btn-outline-info(type="submit" title="Sync menu from this provider reference")
                                                    i.bi.bi-arrow-repeat
                                            form.d-inline(method="POST" action=`/restaurants/${r.id}/providers/${ref.id}/delete`)
                                                +csrf
                                                button.btn.btn-sm.btn-outline-danger(type="submit" title="Remove")
                                                    i.bi.bi-trash

    .card.text-bg-dark.border-secondary.mt-4
        .card-header.d-flex.justify-content-between.align-items-center
            span
                i.bi.bi-menu-button-wide.me-2
                | Menu
            a.btn.btn-sm.btn-success(href=`/restaurants/${r.id}/menu/categories/new`)
                i.bi.bi-plus-lg.me-1
                | Add Category
        .card-body
            if categories.length === 0
                .text-center.text-white-50.py-3
                    i.bi.bi-menu-button-wide.d-block.display-6.mb-2
                    p No menu categories yet.
            else
                each cat in categories
                    .card.text-bg-dark.border-secondary.mb-3
                        .card-header.d-flex.justify-content-between.align-items-center
                            span
                                i.bi.bi-list-ul.me-2
                                | #{cat.name}
                                if !cat.isActive
                                    span.badge.text-bg-secondary.ms-2 Inactive
                            .d-flex.gap-1
                                a.btn.btn-sm.btn-outline-light(href=`/restaurants/${r.id}/menu/categories/${cat.id}/items/new` title="Add Item")
                                    i.bi.bi-plus-lg
                                a.btn.btn-sm.btn-outline-light(href=`/restaurants/${r.id}/menu/categories/${cat.id}/edit` title="Edit Category")
                                    i.bi.bi-pencil
                        .card-body
                            - const items = cat.items || []
                            if items.length === 0
                                p.text-white-50.mb-0 No items in this category.
                            else
                                .table-responsive
                                    table.table.table-dark.table-hover.mb-0
                                        thead
                                            tr
                                                th Name
                                                th Description
                                                th Allergens
                                                th Price
                                                th Actions
                                        tbody
                                            each item in items
                                                - const chips = itemDietChips[item.id] || []
                                                tr(id=`menu-item-${item.id}`)
                                                    td
                                                        a.text-decoration-none.text-light(href=`#menu-item-${item.id}`) #{item.name}
                                                        if chips.length > 0
                                                            .d-flex.flex-wrap.gap-1.mt-1
                                                                each chip in chips
                                                                    span.badge(class=chip.source === 'manual' ? 'text-bg-warning text-dark' : 'text-bg-success') #{chip.label}
                                                    td.text-white-50 #{item.description || '-'}
                                                    td
                                                        if item.allergens
                                                            span.text-warning.small #{item.allergens}
                                                        else
                                                            span.text-white-50 -
                                                    td
                                                        if item.price != null
                                                            | #{parseFloat(item.price).toFixed(2)}
                                                            if item.currency
                                                                |  #{item.currency}
                                                        else
                                                            span.text-white-50 -
                                                    td
                                                        a.btn.btn-sm.btn-outline-light(href=`/restaurants/${r.id}/menu/items/${item.id}/edit` title="Edit Item")
                                                            i.bi.bi-pencil

    .d-flex.gap-2.mt-4
        a.btn.btn-primary(href=`/restaurants/${r.id}/edit`)
            i.bi.bi-pencil.me-1
            | Edit
        a.btn.btn-outline-light(href="/restaurants")
            i.bi.bi-arrow-left.me-1
            | Back to list
