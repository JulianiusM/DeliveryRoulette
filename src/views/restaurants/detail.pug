//- views/restaurants/detail.pug – Restaurant Detail
extends ../layout

block meta
    title #{data.restaurant.name} | DeliveryRoulette

block title
    h1.card-header.text-center
        i.bi.bi-shop.me-2
        | #{data.restaurant.name}

block content
    - const r = data.restaurant
    - const categories = data.categories || []

    .row.g-4
        .col-md-8
            .card.text-bg-dark.border-secondary
                .card-header
                    i.bi.bi-geo-alt.me-2
                    | Address
                .card-body
                    p.mb-1 #{r.addressLine1}
                    if r.addressLine2
                        p.mb-1 #{r.addressLine2}
                    p.mb-0 #{r.postalCode} #{r.city}
                    if r.country
                        p.mb-0 #{r.country}

        .col-md-4
            .card.text-bg-dark.border-secondary
                .card-header
                    i.bi.bi-info-circle.me-2
                    | Info
                .card-body
                    p.mb-2
                        | Status:&nbsp;
                        if r.isActive
                            span.badge.text-bg-success Active
                        else
                            span.badge.text-bg-secondary Inactive
                    p.text-white-50.mb-1
                        small Created: #{new Date(r.createdAt).toLocaleDateString()}
                    p.text-white-50.mb-0
                        small Updated: #{new Date(r.updatedAt).toLocaleDateString()}

    //── Diet Suitability Section ─────────────────────────────
    .card.text-bg-dark.border-secondary.mt-4
        .card-header.d-flex.justify-content-between.align-items-center
            span
                i.bi.bi-heart-pulse.me-2
                | Diet Suitability
            button.btn.btn-sm.btn-success(type="button" data-bs-toggle="collapse" data-bs-target="#addOverrideForm")
                i.bi.bi-plus-lg.me-1
                | Add Override
        .card-body
            #addOverrideForm.collapse.mb-3
                form(method="POST" action=`/restaurants/${r.id}/diet-overrides`)
                    .row.g-2
                        .col-md-4
                            select.form-select.form-select-sm(name="dietTagId" required)
                                option(value="" disabled selected) Select diet tag…
                                each dt in dietSuitability
                                    option(value=dt.dietTagId) #{dt.dietTagLabel}
                        .col-md-3
                            select.form-select.form-select-sm(name="supported" required)
                                option(value="" disabled selected) Supports?
                                option(value="true") Yes — Supports
                                option(value="false") No — Does not support
                        .col-md-3
                            input.form-control.form-control-sm(type="text" name="notes" placeholder="Notes (optional)")
                        .col-md-2
                            button.btn.btn-sm.btn-success.w-100(type="submit")
                                i.bi.bi-plus-lg.me-1
                                | Add

            if dietSuitability.length === 0
                .text-center.text-white-50.py-3
                    i.bi.bi-heart-pulse.d-block.display-6.mb-2
                    p No diet tags configured yet.
            else
                .table-responsive
                    table.table.table-dark.table-hover.mb-0
                        thead
                            tr
                                th Diet Tag
                                th Status
                                th Source
                                th Details
                                th Actions
                        tbody
                            each ds in dietSuitability
                                tr
                                    td #{ds.dietTagLabel}
                                    td
                                        if ds.supported === true
                                            span.badge.text-bg-success Supported
                                        else if ds.supported === false
                                            span.badge.text-bg-danger Not Supported
                                        else
                                            span.badge.text-bg-secondary No Data
                                    td
                                        if ds.source === 'override'
                                            span.badge.text-bg-warning Manual Override
                                        else if ds.source === 'inference'
                                            span.badge.text-bg-info Heuristic
                                        else
                                            span.text-white-50 —
                                    td.text-white-50
                                        if ds.source === 'override' && ds.override && ds.override.notes
                                            | #{ds.override.notes}
                                        else if ds.source === 'inference' && ds.inference
                                            | Score: #{ds.inference.score}% (#{ds.inference.confidence})
                                        else
                                            | —
                                    td
                                        if ds.source === 'override' && ds.override
                                            form.d-inline(method="POST" action=`/restaurants/${r.id}/diet-overrides/${ds.override.id}/delete`)
                                                button.btn.btn-sm.btn-outline-danger(type="submit" title="Remove Override")
                                                    i.bi.bi-trash

    //── Provider References Section ──────────────────────────
    - const providerRefs = data.providerRefs || []
    - const dietSuitability = data.dietSuitability || []
    .card.text-bg-dark.border-secondary.mt-4
        .card-header.d-flex.justify-content-between.align-items-center
            span
                i.bi.bi-link-45deg.me-2
                | Provider References
            button.btn.btn-sm.btn-success(type="button" data-bs-toggle="collapse" data-bs-target="#addProviderForm")
                i.bi.bi-plus-lg.me-1
                | Add Provider
        .card-body
            #addProviderForm.collapse.mb-3
                form(method="POST" action=`/restaurants/${r.id}/providers`)
                    .row.g-2
                        .col-md-3
                            input.form-control.form-control-sm(type="text" name="providerKey" placeholder="Provider key (e.g. uber_eats)" required)
                        .col-md-3
                            input.form-control.form-control-sm(type="text" name="externalId" placeholder="External ID (optional)")
                        .col-md-4
                            input.form-control.form-control-sm(type="url" name="url" placeholder="URL" required)
                        .col-md-2
                            button.btn.btn-sm.btn-success.w-100(type="submit")
                                i.bi.bi-plus-lg.me-1
                                | Add

            if providerRefs.length === 0
                .text-center.text-white-50.py-3
                    i.bi.bi-link-45deg.d-block.display-6.mb-2
                    p No provider references yet.
            else
                .table-responsive
                    table.table.table-dark.table-hover.mb-0
                        thead
                            tr
                                th Provider
                                th External ID
                                th URL
                                th Status
                                th Actions
                        tbody
                            each ref in providerRefs
                                tr
                                    td #{ref.providerKey}
                                    td.text-white-50 #{ref.externalId || '—'}
                                    td
                                        a.text-info(href=ref.url target="_blank" rel="noopener noreferrer") #{ref.url}
                                    td
                                        span.badge(class=ref.status === 'active' ? 'text-bg-success' : 'text-bg-secondary') #{ref.status}
                                    td
                                        form.d-inline(method="POST" action=`/restaurants/${r.id}/providers/${ref.id}/delete`)
                                            button.btn.btn-sm.btn-outline-danger(type="submit" title="Remove")
                                                i.bi.bi-trash

    //── Menu Section ─────────────────────────────────────
    .card.text-bg-dark.border-secondary.mt-4
        .card-header.d-flex.justify-content-between.align-items-center
            span
                i.bi.bi-menu-button-wide.me-2
                | Menu
            a.btn.btn-sm.btn-success(href=`/restaurants/${r.id}/menu/categories/new`)
                i.bi.bi-plus-lg.me-1
                | Add Category
        .card-body
            if categories.length === 0
                .text-center.text-white-50.py-3
                    i.bi.bi-menu-button-wide.d-block.display-6.mb-2
                    p No menu categories yet.
            else
                each cat in categories
                    .card.text-bg-dark.border-secondary.mb-3
                        .card-header.d-flex.justify-content-between.align-items-center
                            span
                                i.bi.bi-list-ul.me-2
                                | #{cat.name}
                                if !cat.isActive
                                    span.badge.text-bg-secondary.ms-2 Inactive
                            .d-flex.gap-1
                                a.btn.btn-sm.btn-outline-light(href=`/restaurants/${r.id}/menu/categories/${cat.id}/items/new` title="Add Item")
                                    i.bi.bi-plus-lg
                                a.btn.btn-sm.btn-outline-light(href=`/restaurants/${r.id}/menu/categories/${cat.id}/edit` title="Edit Category")
                                    i.bi.bi-pencil
                        .card-body
                            - const items = cat.items || []
                            if items.length === 0
                                p.text-white-50.mb-0 No items in this category.
                            else
                                .table-responsive
                                    table.table.table-dark.table-hover.mb-0
                                        thead
                                            tr
                                                th Name
                                                th Description
                                                th Price
                                                th Actions
                                        tbody
                                            each item in items
                                                tr
                                                    td #{item.name}
                                                    td.text-white-50 #{item.description || '—'}
                                                    td
                                                        if item.price != null
                                                            | #{parseFloat(item.price).toFixed(2)}
                                                            if item.currency
                                                                |  #{item.currency}
                                                        else
                                                            span.text-white-50 —
                                                    td
                                                        a.btn.btn-sm.btn-outline-light(href=`/restaurants/${r.id}/menu/items/${item.id}/edit` title="Edit Item")
                                                            i.bi.bi-pencil

    .d-flex.gap-2.mt-4
        a.btn.btn-primary(href=`/restaurants/${r.id}/edit`)
            i.bi.bi-pencil.me-1
            | Edit
        a.btn.btn-outline-light(href="/restaurants")
            i.bi.bi-arrow-left.me-1
            | Back to list
